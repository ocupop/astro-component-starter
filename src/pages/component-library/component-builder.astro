---
import LibraryLayout from "@component-library/layouts/LibraryLayout.astro";
import { getCollection } from "astro:content";
import { discoverComponents } from "@component-library/components/ComponentBuilder/utils/componentDiscovery";
import { getComponentMetadataMap, getNestedBlockProperties } from "@component-library/components/ComponentViewer/utils/componentMetadata";
import ComponentBuilder from "@component-library/components/ComponentBuilder/ComponentBuilder.astro";

export async function getStaticPaths() {
  // Skip component library routes if DISABLE_COMPONENT_LIBRARY is set
  if (process.env.DISABLE_COMPONENT_LIBRARY === "true") {
    return [];
  }

  return [{ params: {} }];
}

// Load all component data at build time
const componentDiscovery = await discoverComponents();
const metadataMap = await getComponentMetadataMap();
const nestedBlockProperties = await getNestedBlockProperties();

// Convert Map to plain object for JSON serialization
const metadataMapObj: Record<string, any> = {};
metadataMap.forEach((value, key) => {
  metadataMapObj[key] = value;
});

const nestedBlockPropertiesArray = Array.from(nestedBlockProperties);
---

<LibraryLayout frontmatter={{ title: "Component Builder", contentSections: [] }}>
  <ComponentBuilder
    components={componentDiscovery.components}
    componentsByCategory={componentDiscovery.byCategory}
    metadataMap={metadataMapObj}
    nestedBlockProperties={nestedBlockPropertiesArray}
    nestingRules={componentDiscovery.nestingRules}
    pageSectionCategories={componentDiscovery.pageSectionCategories}
  />
</LibraryLayout>
